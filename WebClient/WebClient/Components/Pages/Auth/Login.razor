@page "/Auth/Login"
@using WebClient.Components.Layout
@using WebClient.Services.Api
@using WebClient.Services.Common
@using WebClient.Services.Components
@inject AuthService AuthService
@inject ToastService ToastService
@inject NavigationManager NavManager
@layout AuthLayout
@inject IJSRuntime Js
@inject IBaseService BaseService
@inject IHttpClientFactory ClientFactory
@inject HttpClient SelfHttp
@rendermode InteractiveServer
@using global::Shared.DTOs
@using WebClient.Components.Shared.Loadings


<PageTitle>ورود</PageTitle>
<!-- لود کردن فایل استایل انیمیشن -->
<link href="css/LoginAnimationStyle.css" rel="stylesheet"/>

<div class="hero bg-base-200 min-h-screen" id="loginPage">
    <div class="hero-content flex-col lg:flex-row-reverse gap-20">
        <!-- بخش متن سمت راست -->
        <div class="flex-1 hidden lg:flex flex-col items-center">
            <img src="images/loginImage.svg" alt="ورود به سامانه" class="max-w-md w-full animate-fade-in"/>
        </div>

        <!-- کارت لاگین -->
        <div class="card bg-base-100 w-full max-w-sm shrink-0 shadow-2xl">
            <div class="card-body">
                <h2 class="text-3xl font-bold mb-6 text-center lg:text-right">ورود به سامانه</h2>
                <fieldset class="fieldset">
                    <label class="label">نام کاربری</label>
                    <input @bind="_userName" type="text" class="input input-bordered" placeholder="نام کاربری"/>

                    <label class="label">رمز عبور</label>
                    <input @bind="_password" type="password" class="input input-bordered" placeholder="رمز عبور"/>

                    <!-- کپچا -->
                    <div class="recaptcha-google-style mt-3" @onclick="HandleCaptchaClick">
                        <div class="recaptcha-checkbox">
                            <span class="recaptcha-box">
                                @if (_isLoadingCaptcha)
                                {
                                    <div class="recaptcha-spinner"></div>
                                }
                                else if (_isHumanVerified)
                                {
                                    <svg viewBox="0 0 24 24" width="18" height="18">
                                        <path fill="none" stroke="#34a853" stroke-width="3" d="M4 12l6 6L20 6"/>
                                    </svg>
                                }
                            </span>
                            <span class="recaptcha-label">من ربات نیستم</span>
                        </div>

                        <div class="recaptcha-logo">
                            <svg viewBox="0 0 18 18" width="18" height="18" aria-hidden="true">
                                <path fill="#4285F4"
                                      d="M9 0c-1.847 0-3.345 1.167-3.904 2.773L6.087 5.5H2.5v6h6v-3.585l2.727-1.99A3.497 3.497 0 0 1 15 9c0 1.657-1.343 3-3 3-1.116 0-2.086-.607-2.594-1.5H6.5c.508 1.22 1.67 2 3 2 1.657 0 3-1.343 3-3 0-1.436-1.08-2.613-2.5-2.902V6h3.5v1h-2.027a4.978 4.978 0 0 0-1.473-.13C12.04 6.87 13 7.797 13 9c0 1.657-1.343 3-3 3-1.63 0-2.949-1.313-2.999-2.935L6 9.034V8.5h3v1H9z"/>
                            </svg>
                            <span class="recaptcha-text">reCAPTCHA</span>
                        </div>
                    </div>

                    <div class="mt-2">
                        <a @onclick="GoToForgotPassword" class="link link-hover text-sm cursor-pointer">
                            فراموشی رمز عبور؟
                        </a>
                    </div>

                    <LoadingBtn ButtonText="ورود" IsLoading="_isBusy" OnClick="LoginAsync"
                                CssClass="btn-primary mt-4 w-full"></LoadingBtn>
                </fieldset>
            </div>
        </div>
    </div>
</div>

@code {
    private string _userName = "";
    private string _password = "";
    private string _captchaToken = "";
    private bool _isBusy;
    private bool _isLoadingCaptcha;
    private bool _isHumanVerified;
    string? returnUrl;

    protected override void OnInitialized()
    {
        var uri = new Uri(NavManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue(nameof(returnUrl), out var value))
        {
            returnUrl = value;
        }

        SelfHttp.BaseAddress = new Uri(NavManager.BaseUri);
    }

    private async Task LoginForm()
    {
        var jwtToken = AuthService.Token;
        var claims = string.Join(',' ,AuthService.Claims);

        var js = $@"
            var form = document.createElement('form');
            form.method = 'post';
            form.action = '/auth/SignIn';
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'jwtToken';
            input.value = '{jwtToken}';
            form.appendChild(input);
            var input2 = document.createElement('input');
            input2.type = 'hidden';
            input2.name = 'claims';
            input2.value = '{claims}';
            form.appendChild(input2);
            document.body.appendChild(form);
            form.submit();
        ";

        await Js.InvokeVoidAsync("eval", js);
    }

    private async Task LoginAsync()
    {
        try
        {
            if (!_isHumanVerified || string.IsNullOrEmpty(_captchaToken))
            {
                ToastService.ShowError("لطفاً کپچا را تکمیل کنید.");
                return;
            }

            _isBusy = true;
            var result = await AuthService.LoginAsync(_userName, _password, _captchaToken);

            if (result)
            {
                // NavManager.NavigateTo($"/auth/signIn?jwtToken={AuthService.Token}", forceLoad: true);
                await LoginForm();
                // NavManager.NavigateTo($"/", forceLoad: true);
            }
            else
            {
                _isBusy = false;
                ToastService.ShowError("نام کاربری یا رمز عبور اشتباه است.");
            }
        }
        catch
        {
            ToastService.ShowError("خطا در ورود. لطفاً دوباره تلاش کنید.");
            _isBusy = false;
        }
    }

    private async Task HandleCaptchaClick()
    {
        if (_isLoadingCaptcha || _isHumanVerified)
            return;

        _isLoadingCaptcha = true;
        StateHasChanged();

        // شبیه‌سازی فراخوانی سرویس کپچا (در عمل باید به reCAPTCHA یا hCaptcha وصل شود)
        await Task.Delay(1500);
        _captchaToken = Guid.NewGuid().ToString("N"); // توکن شبیه‌سازی‌شده
        _isHumanVerified = true;
        _isLoadingCaptcha = false;

        StateHasChanged();
    }

    private async Task GoToForgotPassword()
    {
        // اجرای انیمیشن
        await Js.InvokeVoidAsync("eval", "document.getElementById('loginPage').classList.add('page-transition');");
        // صبر برای پایان انیمیشن
        await Task.Delay(600);
        // ریدایرکت
        NavManager.NavigateTo("/Auth/ForgotPassword");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Js.InvokeVoidAsync("localStorage.clear");
        }
    }

}
